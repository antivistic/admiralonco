---
title: "Creating ADRS"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating ADRS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This article describes creating an `ADRS` ADaM with common oncology endpoint parameters
based on RECIST v1.1. Further parameters could be added or users could use the function
arguments to adapt the endpoints for different indications and response criteria.
Examples are currently presented and tested using `ADSL` (ADaM) and `RS`, `TU` (SDTM) inputs.
However, other domains could be used. The functions and workflow could similarly be used
to create an intermediary `ADEVENT` ADaM.

**Note**: *All examples assume CDISC SDTM and/or ADaM format as input unless
otherwise specified.*

# Programming Workflow

* [Read in Data](#readdata)
* [Pre-processing of Input Records](#input)
* [Derive Progressive Disease Parameter](#pd)
* [Derive Response Parameter](#rsp)
* [Derive Clinical Benefit Parameter](#cb)
* [Derive Best Overall Response Parameter](#bor)
* [Derive Best Overall Response of CR/PR Parameter](#bcp)
* [Derive Response Parameters requiring Confirmation](#confirm)
* [Derive Parameters using Independent Review Facility (IRF) responses](#irf)
* [Derive Death Parameter](#death)
* [Derive Last Disease Assessment Parameters](#lsta)
* [Derive Measurable Disease at Baseline Parameter](#mdis)
* [Assign `ASEQ`](#aseq)
* [Add ADSL variables](#adsl_vars)

## Read in Data {#readdata}

To start, all data frames needed for the creation of `ADRS` should be read into
the environment.  This will be a company specific process.  Some of the 
data frames needed may be `ADSL`, `RS` and `TU`.

For example purpose, the SDTM and ADaM datasets (based on CDISC Pilot test data)---which are
included in `{admiraltest}`---are used.

```{r message=FALSE}
library(admiral)
library(admiralonco)
library(dplyr)
library(admiraltest)
library(lubridate)
library(stringr)
library(tibble)
data("admiral_adsl")
data("admiral_rs")
data("admiral_tu")

adsl <- admiral_adsl
rs <- admiral_rs
tu <- admiral_tu

rs <- convert_blanks_to_na(rs)
tu <- convert_blanks_to_na(tu)
```
```{r echo=FALSE}
rs <- filter(rs, USUBJID %in% c('01-701-1015', '01-701-1023', '01-703-1086', '01-703-1096', '01-707-1037', '01-716-1024'))
```

At this step, it may be useful to join `ADSL` to your `RS` domain. Only the
`ADSL` variables used for derivations are selected at this step. The rest of the
relevant `ADSL` would be added later.

```{r eval=TRUE}
adsl_vars <- vars(RANDDT)
adrs <- derive_vars_merged(
  rs,
  dataset_add = adsl,
  new_vars = adsl_vars,
  by_vars = vars(STUDYID, USUBJID)
)
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, RSTESTCD, RSDTC, VISIT, RANDDT),
  filter = RSTESTCD == "OVR" & VISIT == "WEEK 2"
)
```

## Pre-processing of Input Records {#input}

The first step involves company-specific pre-processing of records for the required input to the downstream parameter functions.
Note that this could be needed multiple times (e.g. once for investigator and once for Independent Review Facility (IRF) records).
It could even involve merging input data from other sources besides `RS`, such as `ADTR`.

This step would include any required selection/derivation of `ADT` or applying any necessary partial date imputations,
updating `AVAL` (e.g. this should be ordered from best to worst response), and setting analysis flag `ANL01FL`. Common options for
`ANL01FL` would be to set null for invalid assessments or those occurring after next anti-cancer therapy, or to only flag assessments
on or after after date of first treatment/randomization, or rules to cover the case when a patient has multiple observations per visit
(e.g. by selecting worst value).
Another consideration could be extra potential protocol-specific sources of Progressive Disease such as radiological assessments,
which could be pre-processed here to create a PD record to feed downstream derivations.

The below shows an example of a possible company-specific implementation of this step.

### Select Overall Response Records and Set Parameter Details

In this case we use the overall response records from `RS` from the investigator as our starting point. The parameter details such
as `PARAMCD`, `PARAM` etc will always be company-specific, but an example is shown below so that you can trace through how these
records feed into the other parameter derivations.

```{r}
adrs <- rs %>%
  filter(RSEVAL == "INVESTIGATOR" & RSTESTCD == "OVRLRESP") %>%
  mutate(
    PARAMCD = "OVR",
    PARAM = "Overall Response by Investigator",
    PARCAT1 = "Tumor Response",
    PARCAT2 = "Investigator",
    PARCAT3 = "Recist 1.1"
  )
```
```{r, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, VISIT, RSTESTCD, RSEVAL, PARAMCD, PARAM, PARCAT1, PARCAT2, PARCAT3)
)
```

### Partial Date Imputation

If your data collection allows for partial dates, you could apply a company-specific imputation rule at this stage
when deriving `ADT`. For this example, here we impute missing day to last possible date.

```{r}
adrs <- adrs %>%
  derive_vars_dt(
    dtc = RSDTC,
    new_vars_prefix = "A",
    date_imputation = "last"
  )
```
```{r, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, VISIT, PARAMCD, PARAM, RSSTRESC, RSDTC, ADT)
)
```

### Derive `AVALC` and `AVAL`

Here we populate `AVALC` and create the numeric version as `AVAL` (ordered from best to worst response). If you were
working in different oncology indications you might have different possible response values here, such as `iCR`.

```{r}
adrs <- adrs %>%
  mutate(
    AVALC = RSSTRESC,
    AVAL = case_when(
      AVALC == "CR" ~ 1,
      AVALC == "PR" ~ 2,
      AVALC == "SD" ~ 3,
      AVALC == "NON-CR/NON-PD" ~ 4,
      AVALC == "PD" ~ 5,
      AVALC == "NE" ~ 6,
      TRUE ~ NA_character_
    )
  )
```
```{r, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, VISIT, PARAMCD, PARAM, RSSTRESC, AVALC, AVAL)
)
```

### Derive `ANL01FL`

When deriving `ANL01FL` this is an opportunity to exclude any records that should not contribute to any downstream
parameter derivations. In the below example this includes only selecting valid assessments and those occurring on or
after randomization date.

```{r}
adrs <- adrs %>%
  mutate(
    ANL01FL = case_when(
      !is.na(AVAL) & ADT>=RANDDT ~ "Y",
      TRUE ~ NA_character_
    )
  )
```
```{r, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, VISIT, PARAMCD, PARAM, AVAL, ADT, RANDDT, ANL01FL)
)
```

Note here that we don't filter out records after first `PD` at this stage, as that is specifically catered for in
the `{admiralonco}` parameter derivation functions in the below steps.

## Derive Progressive Disease Parameter {#pd}

Now that we have the input records prepared above with any company-specific requirements, we can start to derive
new parameters. The function `derive_param_first_event()` can be used to find the date of first `PD`.

```{r}
adrs <- adrs %>%
  derive_param_first_event(
    dataset_adsl = adsl,
    source_param = OVR,
    condition = AVALC == "PD" & ANL01FL=”Y”,
    subject_keys = vars(STUDYID, USUBJID),
    set_values_to= vars(
      PARAMCD = "PD",
      PARAM = "Disease Progression by Investigator",
      PARCAT1 = "Tumor Response",
      PARCAT2 = "Investigator",
      PARCAT3 = "Recist 1.1",
      ANL01FL = "Y"
    )
  )
```
```{r, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, VISIT, PARAMCD, PARAM, AVAL, ADT, RANDDT, ANL01FL)
)
```

For progressive disease, response and death parameters shown in steps here and below, in our
examples we show these as `ADRS` parameters, but they could equally be achieved via `ADSL` dates or `ADEVENT`
parameters. All the parameter derivation functions that use these are flexible to allow sourcing these dates
from any input source using `date_source()`.

## Derive Response Parameter {#rsp}

The next required step is to define the source location for this newly derived `PD` date.

```{r}
pd <- date_source(
  dataset_name = “adrs”,
  date = ADT,
  filter = PARAMCD == “PD” & AVALC == “Y”
)
```

The function `derive_param_response()` can then be used to find the date of first response. This differs from
the `derive_param_first_event()` function in that it only looks for events occurring prior to first `PD`.
In the below example, the response condition has been defined as `CR` or `PR`.

```{r}
derive_param_response(
  filter_source = PARAMCD == "OVR" & ANL01FL == "Y",
  source_pd = list(pd),
  source_datasets = list(adrs = adrs),
  resp_cond = AVALC %in% c(“CR”, “PR”),
  set_values_to = vars(
	  PARAMCD = "RSP",
	  PARAM = " Response by Investigator (confirmation not required)",
	  PARCAT1 = "Tumor Response",
	  PARCAT2 = "Investigator",
	  PARCAT3 = "Recist 1.1",
	  ANL01FL = "Y"
  )
)
```
```{r, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, VISIT, PARAMCD, PARAM, AVAL, ADT, ANL01FL),
  filter = PARAMCD == "PD"
)
```

## Derive Clinical Benefit Parameter {#cb}

## Derive Best Overall Response Parameter {#bor}

## Derive Best Overall Response of CR/PR Parameter {#bcp}

## Derive Response Parameters requiring Confirmation {#confirm}

## Derive Parameters using Independent Review Facility (IRF) responses {#irf}


Use RSEVAL == "INDEPENDENT ASSESSOR" & RSEVALID == "RADIOLOGIST 1" for example.


## Derive Death Parameter {#death}

## Derive Last Disease Assessment Parameters {#lsta}

## Derive Measurable Disease at Baseline Parameter {#mdis}

## Assign `ASEQ` {#aseq}

The `{admiral}` function `derive_var_obs_number()` can be used to derive `ASEQ`. An
example call is:

```{r eval=TRUE}
adrs <- derive_var_obs_number(
  adrs,
  new_var = ASEQ,
  by_vars = vars(STUDYID, USUBJID),
  order = vars(PARAMCD, ADT, AVISITN, VISITNUM),
  check_type = "error"
)
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, PARAMCD, ADT, AVISITN, VISIT, ADT, ASEQ),
  filter = USUBJID == "01-701-1015"
)
```

## Add ADSL variables {#adsl_vars}

If needed, the other `ADSL` variables can now be added.
List of ADSL variables already merged held in vector `adsl_vars`.

```{r eval=TRUE}
adrs <- adrs %>%
  derive_vars_merged(
    dataset_add = select(adsl, !!!negate_vars(adsl_vars)),
    by_vars = vars(STUDYID, USUBJID)
  )
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, RFSTDTC, RFENDTC, DTHDTC, DTHFL, AGE, AGEU),
  filter = USUBJID == "01-701-1015"
)
```

# Example Script {#example}

ADaM | Sample Code
---- | --------------
ADRS | [ad_adrs.R](https://github.com/pharmaverse/admiralonco/blob/main/inst/templates/ad_adrs.R){target="_blank"}
