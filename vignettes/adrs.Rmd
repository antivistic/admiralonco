---
title: "Creating ADRS"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating ADRS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This article describes creating an `ADRS` ADaM with common oncology endpoint parameters
based on RECIST v1.1. Further parameters could be added or users could use the function
arguments to adapt the endpoints for different indications and response criteria.
Examples are currently presented and tested using `ADSL` (ADaM) and `RS`, `TU` (SDTM) inputs.
However, other domains could be used. The functions and workflow could similarly be used
to create an intermediary `ADEVENT` ADaM.

**Note**: *All examples assume CDISC SDTM and/or ADaM format as input unless
otherwise specified.*

# Programming Workflow

* [Read in Data](#readdata)
* [Pre-processing of Input Records](#input)
* [Derive Progressive Disease Parameter](#pd)
* [Derive Response Parameter](#rsp)
* [Derive Clinical Benefit Parameter](#cb)
* [Derive Best Overall Response Parameter](#bor)
* [Derive Best Overall Response of CR/PR Parameter](#bcp)
* [Derive Response Parameters requiring Confirmation](#confirm)
* [Derive Parameters using Independent Review Facility responses](#irf)
* [Derive Death Parameter](#death)
* [Derive Last Disease Assessment Parameters](#lsta)
* [Derive Measurable Disease at Baseline Parameter](#mdis)
* [Assign `ASEQ`](#aseq)
* [Add ADSL variables](#adsl_vars)

## Read in Data {#readdata}

To start, all data frames needed for the creation of `ADRS` should be read into
the environment.  This will be a company specific process.  Some of the 
data frames needed may be `ADSL`, `RS` and `TU`.

For example purpose, the SDTM and ADaM datasets (based on CDISC Pilot test data)---which are
included in `{admiraltest}`---are used.

```{r message=FALSE}
library(admiral)
library(admiralonco)
library(dplyr)
library(admiraltest)
library(lubridate)
library(stringr)
library(tibble)
data("adsl")
data("rs")
data("tu")
rs <- convert_blanks_to_na(rs)
tu <- convert_blanks_to_na(tu)
```
```{r echo=FALSE}
rs <- filter(rs, USUBJID %in% c('01-701-1015', '01-701-1023', '01-703-1086', '01-703-1096', '01-707-1037', '01-716-1024'))
```

At this step, it may be useful to join `ADSL` to your `RS` domain. Only the
`ADSL` variables used for derivations are selected at this step. The rest of the
relevant `ADSL` would be added later.

```{r eval=TRUE}
adsl_vars <- vars(RANDDT)
adrs <- derive_vars_merged(
  rs,
  dataset_add = adsl,
  new_vars = adsl_vars,
  by_vars = vars(STUDYID, USUBJID)
)
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, RSTESTCD, RSDTC, VISIT, RANDDT),
  filter = RSTESTCD == "OVR" & VISIT == "WEEK 2"
)
```

## Pre-processing of Input Records {#input}

## Derive Progressive Disease Parameter {#pd}

## Derive Response Parameter {#rsp}

## Derive Clinical Benefit Parameter {#cb}

## Derive Best Overall Response Parameter {#bor}

## Derive Best Overall Response of CR/PR Parameter {#bcp}

## Derive Response Parameters requiring Confirmation {#confirm}

## Derive Parameters using Independent Review Facility responses {#irf}

## Derive Death Parameter {#death}

## Derive Last Disease Assessment Parameters {#lsta}

## Derive Measurable Disease at Baseline Parameter {#mdis}

## Assign `ASEQ` {#aseq}

The `{admiral}` function `derive_var_obs_number()` can be used to derive `ASEQ`. An
example call is:

```{r eval=TRUE}
adrs <- derive_var_obs_number(
  adrs,
  new_var = ASEQ,
  by_vars = vars(STUDYID, USUBJID),
  order = vars(PARAMCD, ADT, AVISITN, VISITNUM),
  check_type = "error"
)
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, PARAMCD, ADT, AVISITN, VISIT, ADT, ASEQ),
  filter = USUBJID == "01-701-1015"
)
```

## Add ADSL variables {#adsl_vars}

If needed, the other `ADSL` variables can now be added.
List of ADSL variables already merged held in vector `adsl_vars`.

```{r eval=TRUE}
adrs <- adrs %>%
  derive_vars_merged(
    dataset_add = select(adsl, !!!negate_vars(adsl_vars)),
    by_vars = vars(STUDYID, USUBJID)
  )
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, RFSTDTC, RFENDTC, DTHDTC, DTHFL, AGE, AGEU),
  filter = USUBJID == "01-701-1015"
)
```

# Example Script {#example}

ADaM | Sample Code
---- | --------------
ADRS | [ad_adrs.R](https://github.com/pharmaverse/admiralonco/blob/main/inst/templates/ad_adrs.R){target="_blank"}
