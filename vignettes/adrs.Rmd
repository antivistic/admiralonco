---
title: "Creating ADRS"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating ADRS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This article describes creating an `ADRS` ADaM with common oncology endpoint parameters
based on RECIST v1.1. Further parameters could be added or users could use the function
arguments to adapt the endpoints for different indications and response criteria.
Examples are currently presented and tested using `ADSL` (ADaM) and `RS`, `TU` (SDTM) inputs.
However, other domains could be used. The functions and workflow could similarly be used
to create an intermediary `ADEVENT` ADaM.

**Note**: *All examples assume CDISC SDTM and/or ADaM format as input unless
otherwise specified.*

# Programming Workflow

* [Read in Data](#readdata)
* [Pre-processing of Input Records](#input)
* [Derive Progressive Disease Parameter](#pd)
* [Derive Response Parameter](#rsp)
* [Derive Clinical Benefit Parameter](#cb)
* [Derive Best Overall Response Parameter](#bor)
* [Derive Best Overall Response of CR/PR Parameter](#bcp)
* [Derive Response Parameters requiring Confirmation](#confirm)
* [Derive Parameters using Independent Review Facility (IRF) responses](#irf)
* [Derive Death Parameter](#death)
* [Derive Last Disease Assessment Parameters](#lsta)
* [Derive Measurable Disease at Baseline Parameter](#mdis)
* [Assign `ASEQ`](#aseq)
* [Add ADSL variables](#adsl_vars)

## Read in Data {#readdata}

To start, all data frames needed for the creation of `ADRS` should be read into
the environment.  This will be a company specific process.  Some of the 
data frames needed may be `ADSL`, `RS` and `TU`.

For example purpose, the SDTM and ADaM datasets (based on CDISC Pilot test data)---which are
included in `{admiraltest}`---are used.

```{r message=FALSE}
library(admiral)
library(admiralonco)
library(dplyr)
library(admiraltest)
library(lubridate)
library(stringr)
library(tibble)
data("admiral_adsl")
data("admiral_rs")
data("admiral_tu")

adsl <- admiral_adsl
rs <- admiral_rs
tu <- admiral_tu

rs <- convert_blanks_to_na(rs)
tu <- convert_blanks_to_na(tu)
```
```{r echo=FALSE}
rs <- filter(rs, USUBJID %in% c('01-701-1015', '01-701-1023', '01-703-1086', '01-703-1096', '01-707-1037', '01-716-1024'))
```

At this step, it may be useful to join `ADSL` to your `RS` domain. Only the
`ADSL` variables used for derivations are selected at this step. The rest of the
relevant `ADSL` would be added later.

```{r eval=TRUE}
adsl_vars <- vars(RANDDT)
adrs <- derive_vars_merged(
  rs,
  dataset_add = adsl,
  new_vars = adsl_vars,
  by_vars = vars(STUDYID, USUBJID)
)
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, RSTESTCD, RSDTC, VISIT, RANDDT),
  filter = RSTESTCD == "OVR" & VISIT == "WEEK 2"
)
```

## Pre-processing of Input Records {#input}

The first step involves company-specific pre-processing of records for the required input to the downstream parameter functions.
Note that this could be needed multiple times (e.g. once for investigator and once for Independent Review Facility (IRF) records).
It could even involve merging input data from other sources besides `RS`, such as `ADTR`.

This step would include any required selection/derivation of `ADT` or applying any necessary partial date imputations,
updating `AVAL` (e.g. this should be ordered from best to worst response), and setting analysis flag `ANL01FL`. Common options for
ANL01FL would be to only flag assessments on or after after date of first treatment/randomization, setting null for assessments
after next anti-cancer therapy, or rules to cover the case when a patient has multiple observations per visit.
Another consideration could be extra potential sources of Progressive Disease such as radiological assessments, which could be
pre-processed here to create a PD record to feed downstream derivations.

The below shows an example of a possible company-specific implementation of this step.

### Select Overall Response Records

In this case we use the overall response records from `RS` from the investigator as our starting point.

```{r}
adrs <- rs %>%
  filter(RSEVAL == "INVESTIGATOR" & RSTESTCD == "OVRLRESP")
```
```{r, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, RSTESTCD, RSEVAL, RSDTC, VISIT)
)
```

### Partial Date Imputation

If your data collection allows for partial dates, you could apply a company-specific imputation rule at this stage. 
For this example, here we impute missing day as the last day of the month for `CR`/`PR`, otherwise missing day is imputed as '01'.
Missing month and year are not imputed.

```{r}
adrs <- adrs %>%
  slice_derivation(
    derivation = derive_vars_dt,
    args = params(
      dtc = RSDTC,
      new_vars_prefix = "A"
      ),
    slices = list(
      slice(
        filter = RSSTRESC %in% c("CR","PR") & nchar(RSDTC) >= 7,
        args = params(
          date_imputation = "last"
         )),
      slice(
        filter = nchar(RSDTC) >= 7,
        args = params(
          date_imputation = "first"
         )))
  )
```
```{r, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, RSSTRESC, RSDTC, ADT)
)
```

### Derive `AVAL`

### Derive `ANL01FL`


Note: it is important to explain in our ADRS vignette why we don’t filter out the records after PD at this stage in ANL01FL. Reason being we need them to derive PD parameter and also not considering responses after PD is the one common rule here that all the response endpoints will always need. If we rely on the users to do that up front then we can’t really call our BOR function as BOR for example.


## Derive Progressive Disease Parameter {#pd}


Consider ADEVENT possible set-up that some companies use, and include examples where PD and RESP dates are passed from an intermeidate dataset
rather than from already derived ADRS params. Or even from ADSL vars.


## Derive Response Parameter {#rsp}

## Derive Clinical Benefit Parameter {#cb}

## Derive Best Overall Response Parameter {#bor}

## Derive Best Overall Response of CR/PR Parameter {#bcp}

## Derive Response Parameters requiring Confirmation {#confirm}

## Derive Parameters using Independent Review Facility (IRF) responses {#irf}


Use RSEVAL == "INDEPENDENT ASSESSOR" & RSEVALID == "RADIOLOGIST 1" for example.


## Derive Death Parameter {#death}

## Derive Last Disease Assessment Parameters {#lsta}

## Derive Measurable Disease at Baseline Parameter {#mdis}

## Assign `ASEQ` {#aseq}

The `{admiral}` function `derive_var_obs_number()` can be used to derive `ASEQ`. An
example call is:

```{r eval=TRUE}
adrs <- derive_var_obs_number(
  adrs,
  new_var = ASEQ,
  by_vars = vars(STUDYID, USUBJID),
  order = vars(PARAMCD, ADT, AVISITN, VISITNUM),
  check_type = "error"
)
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, PARAMCD, ADT, AVISITN, VISIT, ADT, ASEQ),
  filter = USUBJID == "01-701-1015"
)
```

## Add ADSL variables {#adsl_vars}

If needed, the other `ADSL` variables can now be added.
List of ADSL variables already merged held in vector `adsl_vars`.

```{r eval=TRUE}
adrs <- adrs %>%
  derive_vars_merged(
    dataset_add = select(adsl, !!!negate_vars(adsl_vars)),
    by_vars = vars(STUDYID, USUBJID)
  )
```

```{r, eval=TRUE, echo=FALSE}
dataset_vignette(
  adrs,
  display_vars = vars(USUBJID, RFSTDTC, RFENDTC, DTHDTC, DTHFL, AGE, AGEU),
  filter = USUBJID == "01-701-1015"
)
```

# Example Script {#example}

ADaM | Sample Code
---- | --------------
ADRS | [ad_adrs.R](https://github.com/pharmaverse/admiralonco/blob/main/inst/templates/ad_adrs.R){target="_blank"}
